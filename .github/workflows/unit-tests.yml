name: Unit Tests with Excel Report

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    # ================== SETUP MÃ”TRÆ¯á»œNG ==================
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          nuget-${{ runner.os }}-

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        cache: true
        cache-dependency-path: '**/*.csproj'

    # ================== SETUP PYTHON CHO EXCEL ==================
    - name: Setup Python for Excel generation
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        # CÃ i Ä‘áº·t thÆ° viá»‡n Python cáº§n thiáº¿t Ä‘á»ƒ táº¡o file Excel
        pip install pandas openpyxl xlsxwriter lxml beautifulsoup4
        
    # ================== BUILD VÃ€ CHáº Y TEST ==================
    - name: Restore dependencies
      run: dotnet restore BlindTreasure.API.sln
      
    - name: Build
      run: dotnet build BlindTreasure.API.sln --no-restore --configuration Release
      
    - name: Restore tools
      run: dotnet tool restore
      
    - name: Run unit tests
      run: |
        # Cháº¡y unit tests vÃ  táº¡o file coverage + test results
        dotnet test BlindTreasure.API.sln \
          --no-build \
          --configuration Release \
          --verbosity normal \
          --collect:"XPlat Code Coverage" \           # Táº¡o file coverage
          --results-directory ./TestResults/ \
          --logger "trx;LogFileName=test-results.trx"  # Táº¡o file test results
      
    - name: Generate coverage report
      run: |
        # Táº¡o bÃ¡o cÃ¡o coverage tá»« file XML thÃ nh HTML, JSON, Markdown
        dotnet tool run reportgenerator \
          -reports:"./TestResults/**/coverage.cobertura.xml" \
          -targetdir:"./coveragereport" \
          -reporttypes:"Html;Badges;TextSummary;JsonSummary;MarkdownSummaryGithub;Xml;Cobertura"
      
    # ================== Táº O FILE EXCEL - PHáº¦N QUAN TRá»ŒNG NHáº¤T ==================
    - name: Create Excel coverage report
      run: |
        # Táº¡o file Python script inline Ä‘á»ƒ generate Excel report
        cat > generate_excel_report.py << 'EOF'
        import pandas as pd
        import json
        import xml.etree.ElementTree as ET
        from datetime import datetime
        import os
        import glob
        from bs4 import BeautifulSoup
        
        def parse_cobertura_xml():
            """Parse file XML coverage Ä‘á»ƒ láº¥y dá»¯ liá»‡u chi tiáº¿t"""
            xml_files = glob.glob('./TestResults/**/coverage.cobertura.xml', recursive=True)
            if not xml_files:
                return None
                
            tree = ET.parse(xml_files[0])
            root = tree.getroot()
            
            # Láº¥y thÃ´ng tin tá»•ng quan vá» coverage
            line_rate = float(root.get('line-rate', 0)) * 100
            branch_rate = float(root.get('branch-rate', 0)) * 100
            
            # Láº¥y chi tiáº¿t coverage theo tá»«ng class/file
            classes_data = []
            packages = root.findall('.//package')
            
            for package in packages:
                package_name = package.get('name', 'Unknown')
                classes = package.findall('.//class')
                
                for cls in classes:
                    class_name = cls.get('name', 'Unknown')
                    filename = cls.get('filename', 'Unknown')
                    class_line_rate = float(cls.get('line-rate', 0)) * 100
                    class_branch_rate = float(cls.get('branch-rate', 0)) * 100
                    
                    # Äáº¿m sá»‘ dÃ²ng Ä‘Æ°á»£c cover vÃ  chÆ°a cover
                    lines = cls.findall('.//line')
                    total_lines = len(lines)
                    covered_lines = len([l for l in lines if l.get('hits', '0') != '0'])
                    
                    classes_data.append({
                        'Package': package_name,
                        'Class': class_name,
                        'File': filename,
                        'Line Coverage (%)': round(class_line_rate, 2),
                        'Branch Coverage (%)': round(class_branch_rate, 2),
                        'Total Lines': total_lines,
                        'Covered Lines': covered_lines,
                        'Uncovered Lines': total_lines - covered_lines
                    })
            
            return {
                'summary': {
                    'line_coverage': round(line_rate, 2),
                    'branch_coverage': round(branch_rate, 2)
                },
                'classes': classes_data
            }
        
        def parse_test_results():
            """Parse file TRX Ä‘á»ƒ láº¥y káº¿t quáº£ test chi tiáº¿t"""
            trx_files = glob.glob('./TestResults/**/test-results.trx', recursive=True)
            test_data = []
            
            if trx_files:
                try:
                    with open(trx_files[0], 'r', encoding='utf-8') as f:
                        content = f.read()
                        soup = BeautifulSoup(content, 'xml')
                        
                    # Parse tá»«ng test result
                    test_results = soup.find_all('UnitTestResult')
                    for result in test_results:
                        test_name = result.get('testName', 'Unknown')
                        outcome = result.get('outcome', 'Unknown')
                        duration = result.get('duration', '00:00:00')
                        
                        # Láº¥y error message náº¿u test fail
                        error_info = result.find('ErrorInfo')
                        error_message = ""
                        if error_info:
                            message_elem = error_info.find('Message')
                            if message_elem:
                                error_message = message_elem.get_text()
                        
                        test_data.append({
                            'Test Name': test_name,
                            'Result': outcome,
                            'Duration': duration,
                            'Error Message': error_message
                        })
                except Exception as e:
                    print(f"Error parsing TRX file: {e}")
            
            return test_data
        
        def create_excel_report():
            """ğŸ”¥ HÃ€M CHÃNH Táº O FILE EXCEL ğŸ”¥"""
            
            # Parse dá»¯ liá»‡u tá»« cÃ¡c file output
            coverage_data = parse_cobertura_xml()
            test_data = parse_test_results()
            
            # Táº¡o tÃªn file Excel vá»›i timestamp
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            excel_file = f'./coveragereport/Coverage_Report_{timestamp}.xlsx'
            
            # ğŸ“Š Táº O FILE EXCEL Vá»šI NHIá»€U SHEET
            with pd.ExcelWriter(excel_file, engine='xlsxwriter') as writer:
                workbook = writer.book
                
                # ğŸ¨ Äá»ŠNH NGHÄ¨A CÃC FORMAT CHO EXCEL
                header_format = workbook.add_format({
                    'bold': True,
                    'text_wrap': True,
                    'valign': 'top',
                    'fg_color': '#4472C4',      # MÃ u ná»n xanh
                    'font_color': 'white',       # Chá»¯ mÃ u tráº¯ng
                    'border': 1
                })
                
                cell_format = workbook.add_format({
                    'text_wrap': True,
                    'valign': 'top',
                    'border': 1
                })
                
                percent_format = workbook.add_format({
                    'num_format': '0.00%',
                    'text_wrap': True,
                    'valign': 'top',
                    'border': 1
                })
                
                # ğŸ“‹ SHEET 1: SUMMARY - Tá»•ng quan
                summary_data = []
                if coverage_data:
                    summary_data = [
                        ['Metric', 'Value', 'Status'],
                        ['Line Coverage', f"{coverage_data['summary']['line_coverage']}%", 
                         'âœ… Pass' if coverage_data['summary']['line_coverage'] >= 70 else 'âŒ Fail'],
                        ['Branch Coverage', f"{coverage_data['summary']['branch_coverage']}%", ''],
                        ['Test Run Date', datetime.now().strftime("%Y-%m-%d %H:%M:%S"), ''],
                        ['Total Test Classes', len(coverage_data['classes']) if coverage_data['classes'] else 0, ''],
                        ['Minimum Threshold', '70%', ''],
                    ]
                else:
                    summary_data = [
                        ['Metric', 'Value', 'Status'],
                        ['Line Coverage', 'N/A', 'No data available'],
                    ]
                
                df_summary = pd.DataFrame(summary_data[1:], columns=summary_data[0])
                df_summary.to_excel(writer, sheet_name='Summary', index=False)
                
                # Format sheet Summary
                worksheet_summary = writer.sheets['Summary']
                worksheet_summary.set_column('A:A', 20)
                worksheet_summary.set_column('B:B', 15)
                worksheet_summary.set_column('C:C', 15)
                
                # Ãp dá»¥ng format cho tá»«ng cell
                for row_num in range(len(df_summary) + 1):
                    for col_num in range(len(df_summary.columns)):
                        if row_num == 0:
                            worksheet_summary.write(row_num, col_num, df_summary.columns[col_num], header_format)
                        else:
                            worksheet_summary.write(row_num, col_num, df_summary.iloc[row_num-1, col_num], cell_format)
                
                # ğŸ“Š SHEET 2: COVERAGE DETAILS - Chi tiáº¿t coverage theo class
                if coverage_data and coverage_data['classes']:
                    df_classes = pd.DataFrame(coverage_data['classes'])
                    df_classes.to_excel(writer, sheet_name='Coverage Details', index=False)
                    
                    worksheet_details = writer.sheets['Coverage Details']
                    # Set Ä‘á»™ rá»™ng cá»™t
                    worksheet_details.set_column('A:A', 25)  # Package
                    worksheet_details.set_column('B:B', 30)  # Class
                    worksheet_details.set_column('C:C', 40)  # File
                    worksheet_details.set_column('D:D', 18)  # Line Coverage
                    worksheet_details.set_column('E:E', 18)  # Branch Coverage
                    worksheet_details.set_column('F:F', 12)  # Total Lines
                    worksheet_details.set_column('G:G', 15)  # Covered Lines
                    worksheet_details.set_column('H:H', 15)  # Uncovered Lines
                    
                    # Ãp dá»¥ng format
                    for row_num in range(len(df_classes) + 1):
                        for col_num in range(len(df_classes.columns)):
                            if row_num == 0:
                                worksheet_details.write(row_num, col_num, df_classes.columns[col_num], header_format)
                            else:
                                worksheet_details.write(row_num, col_num, df_classes.iloc[row_num-1, col_num], cell_format)
                
                # ğŸ§ª SHEET 3: TEST RESULTS - Káº¿t quáº£ test chi tiáº¿t
                if test_data:
                    df_tests = pd.DataFrame(test_data)
                    df_tests.to_excel(writer, sheet_name='Test Results', index=False)
                    
                    worksheet_tests = writer.sheets['Test Results']
                    worksheet_tests.set_column('A:A', 50)  # Test Name
                    worksheet_tests.set_column('B:B', 12)  # Result
                    worksheet_tests.set_column('C:C', 12)  # Duration
                    worksheet_tests.set_column('D:D', 60)  # Error Message
                    
                    # Highlight test failed vá»›i mÃ u Ä‘á»
                    for row_num in range(len(df_tests) + 1):
                        for col_num in range(len(df_tests.columns)):
                            if row_num == 0:
                                worksheet_tests.write(row_num, col_num, df_tests.columns[col_num], header_format)
                            else:
                                cell_value = df_tests.iloc[row_num-1, col_num]
                                # Highlight failed tests vá»›i background mÃ u Ä‘á» nháº¡t
                                if col_num == 1 and cell_value == 'Failed':
                                    fail_format = workbook.add_format({
                                        'text_wrap': True,
                                        'valign': 'top',
                                        'border': 1,
                                        'bg_color': '#FFE6E6'  # MÃ u Ä‘á» nháº¡t
                                    })
                                    worksheet_tests.write(row_num, col_num, cell_value, fail_format)
                                else:
                                    worksheet_tests.write(row_num, col_num, cell_value, cell_format)
                
                # ğŸ“ˆ SHEET 4: COVERAGE TRENDS - Xu hÆ°á»›ng coverage (Ä‘á»ƒ má»Ÿ rá»™ng sau)
                trends_data = [
                    ['Date', 'Line Coverage (%)', 'Branch Coverage (%)', 'Total Tests'],
                    [datetime.now().strftime("%Y-%m-%d"), 
                     coverage_data['summary']['line_coverage'] if coverage_data else 0,
                     coverage_data['summary']['branch_coverage'] if coverage_data else 0,
                     len(test_data) if test_data else 0]
                ]
                
                df_trends = pd.DataFrame(trends_data[1:], columns=trends_data[0])
                df_trends.to_excel(writer, sheet_name='Coverage Trends', index=False)
                
                worksheet_trends = writer.sheets['Coverage Trends']
                worksheet_trends.set_column('A:A', 15)
                worksheet_trends.set_column('B:B', 18)
                worksheet_trends.set_column('C:C', 18)
                worksheet_trends.set_column('D:D', 15)
                
                # Ãp dá»¥ng format cho trends
                for row_num in range(len(df_trends) + 1):
                    for col_num in range(len(df_trends.columns)):
                        if row_num == 0:
                            worksheet_trends.write(row_num, col_num, df_trends.columns[col_num], header_format)
                        else:
                            worksheet_trends.write(row_num, col_num, df_trends.iloc[row_num-1, col_num], cell_format)
            
            print(f"âœ… Excel report generated: {excel_file}")
            return excel_file
        
        # Táº¡o CSV Ä‘Æ¡n giáº£n Ä‘á»ƒ hiá»ƒn thá»‹ trÃªn GitHub
        def create_csv_summary():
            if os.path.exists('./coveragereport/Summary.json'):
                try:
                    with open('./coveragereport/Summary.json', 'r') as f:
                        summary = json.load(f)
                    
                    # Táº¡o file CSV summary
                    summary_csv = pd.DataFrame([
                        ['Line Coverage', summary.get('summary', {}).get('linecoverage', 'N/A')],
                        ['Branch Coverage', summary.get('summary', {}).get('branchcoverage', 'N/A')],
                        ['Generated', datetime.now().strftime("%Y-%m-%d %H:%M:%S")]
                    ], columns=['Metric', 'Value'])
                    
                    summary_csv.to_csv('./coveragereport/coverage_summary.csv', index=False)
                    print("âœ… CSV summary created")
                except Exception as e:
                    print(f"âŒ Error creating CSV: {e}")
        
        # ğŸš€ CHáº Y CÃC HÃ€M CHÃNH
        if __name__ == "__main__":
            excel_file = create_excel_report()  # ğŸ“Š Táº O FILE EXCEL
            create_csv_summary()                # ğŸ“‹ Táº O FILE CSV
        EOF
        
        # ğŸ CHáº Y PYTHON SCRIPT Äá»‚ Táº O EXCEL
        python generate_excel_report.py
      
    # ================== Xá»¬ LÃ VÃ€ HIá»‚N THá»Š Káº¾T QUáº¢ ==================
    - name: Extract and check coverage
      run: |
        # Parse coverage percentage tá»« nhiá»u nguá»“n khÃ¡c nhau
        # Method 1: Tá»« Summary.txt
        if [ -f "./coveragereport/Summary.txt" ]; then
          echo "ğŸ“„ Using Summary.txt method"
          COVERAGE=$(grep -o 'Line coverage: [0-9]*\.*[0-9]*%' ./coveragereport/Summary.txt | grep -o '[0-9]*\.*[0-9]*' | head -1)
        fi
        
        # Method 2: Tá»« JSON náº¿u method 1 fail  
        if [ -z "$COVERAGE" ] && [ -f "./coveragereport/Summary.json" ]; then
          echo "ğŸ“Š Using Summary.json method"
          if command -v jq &> /dev/null; then
            COVERAGE=$(cat ./coveragereport/Summary.json | jq -r '.summary.linecoverage' 2>/dev/null || echo "")
          else
            COVERAGE=$(cat ./coveragereport/Summary.json | sed -n 's/.*"linecoverage"[[:space:]]*:[[:space:]]*"\([0-9]*\.*[0-9]*\)".*/\1/p' | head -1)
          fi
        fi
        
        # Method 3: Default value náº¿u khÃ´ng parse Ä‘Æ°á»£c
        if [ -z "$COVERAGE" ]; then
          echo "âš ï¸ Cannot parse coverage, using default"
          COVERAGE="0"
        fi
        
        echo "ğŸ“ˆ Current coverage: $COVERAGE%"
        echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
        
        # Kiá»ƒm tra threshold
        THRESHOLD=70
        echo "ğŸ¯ Minimum threshold: $THRESHOLD%"
        
        if [ -n "$COVERAGE" ] && [ "$COVERAGE" != "0" ]; then
          BELOW_THRESHOLD=$(awk "BEGIN {print ($COVERAGE < $THRESHOLD)}")
          if [ "$BELOW_THRESHOLD" = "1" ]; then
            echo "âŒ Coverage $COVERAGE% is below threshold $THRESHOLD%"
            echo "::warning::Code coverage $COVERAGE% is below the required threshold of $THRESHOLD%"
          else
            echo "âœ… Coverage $COVERAGE% meets threshold $THRESHOLD%"
          fi
        else
          echo "âš ï¸ Could not determine coverage percentage"
          echo "::warning::Unable to parse coverage data"
        fi
      
    # ================== HIá»‚N THá»Š SUMMARY TRÃŠN GITHUB ==================
    - name: Display coverage summary
      run: |
        # Táº¡o summary hiá»ƒn thá»‹ trÃªn GitHub Actions page
        echo "## ğŸ“Š Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Coverage:** $COVERAGE%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Hiá»ƒn thá»‹ báº£ng CSV náº¿u cÃ³
        if [ -f "./coveragereport/coverage_summary.csv" ]; then
          echo "### ğŸ“‹ Quick Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          tail -n +2 ./coveragereport/coverage_summary.csv | sed 's/,/ | /g' | sed 's/^/| /' | sed 's/$/ |/' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Hiá»ƒn thá»‹ chi tiáº¿t trong code block
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat ./coveragereport/Summary.txt 2>/dev/null || echo "Summary not available" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“Š **Excel Report Available**: Download the detailed Excel report from artifacts below" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“‹ [Download HTML report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
      
    # ================== COMMENT TRÃŠN PULL REQUEST ==================
    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: marocchino/sticky-pull-request-comment@v2
      continue-on-error: true
      with:
        recreate: true
        header: coverage-report
        message: |
          ## ğŸ“Š Code Coverage Report
          
          **Coverage:** ${{ env.COVERAGE }}%  
          **Threshold:** 70%  
          **Status:** ${{ env.COVERAGE >= 70 && 'âœ… Passed' || 'âš ï¸ Below threshold' }}
          
          ### ğŸ“‹ Quick Summary
          $(if [ -f "./coveragereport/coverage_summary.csv" ]; then
            echo "| Metric | Value |"
            echo "|--------|-------|"
            tail -n +2 ./coveragereport/coverage_summary.csv | sed 's/,/ | /g' | sed 's/^/| /' | sed 's/$/ |/'
          else
            echo "Summary not available"
          fi)
          
          ```
          $(cat ./coveragereport/Summary.txt 2>/dev/null || echo "Summary not available")
          ```
          
          ğŸ“Š **Excel Report Available**: Download detailed Excel report with multiple sheets from [artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
      
    # ================== UPLOAD CÃC FILE ARTIFACTS ==================
    - name: Upload Excel coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: excel-coverage-report
        path: ./coveragereport/Coverage_Report_*.xlsx  # ğŸ“Š Upload file Excel
        retention-days: 30
        
    - name: Upload coverage reports  
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: ./coveragereport/**/*                    # ğŸ“‹ Upload táº¥t cáº£ file coverage
        retention-days: 30
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: ./TestResults/**/*                       # ğŸ§ª Upload file test results
        retention-days: 30